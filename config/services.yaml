services:
  _defaults:
    autowire: true
    autoconfigure: true

  # Persistent Storage Implementation (writable)
  pulse_flags.persistent_storage.db:
    class: Pulse\Flags\Core\Storage\DbStorage
    arguments:
      $dsn: '%pulse_flags.db_dsn%'
      $table: '%pulse_flags.db_table%'

  # Storage Interface alias (points to active persistent storage)
  Pulse\Flags\Core\Storage\StorageInterface:
    alias: pulse_flags.persistent_storage

  # Legacy alias for direct storage access
  Pulse\Flags\Core\Storage\DbStorage:
    alias: pulse_flags.persistent_storage.db

  # Strategies
  Pulse\Flags\Core\Strategy\SimpleStrategy:
    tags: ['pulse_flags.strategy']

  Pulse\Flags\Core\Strategy\PercentageStrategy:
    tags: ['pulse_flags.strategy']

  Pulse\Flags\Core\Strategy\UserIdStrategy:
    tags: ['pulse_flags.strategy']

  Pulse\Flags\Core\Strategy\DateRangeStrategy:
    tags: ['pulse_flags.strategy']

  # Operators for CustomAttributeStrategy
  Pulse\Flags\Core\Strategy\Operator\ContainsOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\Operator\EqualsOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\Operator\NotEqualsOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\Operator\GreaterThanOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\Operator\LessThanOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\Operator\GreaterThanOrEqualsOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\Operator\LessThanOrEqualsOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\Operator\InOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\Operator\NotInOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\Operator\StartsWithOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\Operator\EndsWithOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\Operator\RegexOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\Operator\NotContainsOperator:
    tags: ['pulse_flags.operator']

  Pulse\Flags\Core\Strategy\SegmentStrategy:
    tags: ['pulse_flags.strategy']

  Pulse\Flags\Core\Strategy\CompositeStrategy:
    tags: ['pulse_flags.strategy']
    calls:
      - addStrategy: ['@Pulse\Flags\Core\Strategy\PercentageStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\UserIdStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\DateRangeStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\GeoStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\IpStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\ProgressiveRolloutStrategy']

  # GeoStrategy
  Pulse\Flags\Core\Strategy\GeoStrategy:
    tags: ['pulse_flags.strategy']

  # IpStrategy
  Pulse\Flags\Core\Strategy\IpStrategy:
    tags: ['pulse_flags.strategy']

  # CustomAttributeStrategy
  Pulse\Flags\Core\Strategy\CustomAttributeStrategy:
    arguments:
      $operators: !tagged_iterator pulse_flags.operator
    tags: ['pulse_flags.strategy']

  # ProgressiveRolloutStrategy
  Pulse\Flags\Core\Strategy\ProgressiveRolloutStrategy:
    arguments:
      $percentageStrategy: '@Pulse\Flags\Core\Strategy\PercentageStrategy'
    tags: ['pulse_flags.strategy']

  # Strategy Validators
  Pulse\Flags\Core\Strategy\Validation\SimpleStrategyValidator:
    tags: ['pulse_flags.validator']

  Pulse\Flags\Core\Strategy\Validation\PercentageStrategyValidator:
    tags: ['pulse_flags.validator']

  Pulse\Flags\Core\Strategy\Validation\UserIdStrategyValidator:
    tags: ['pulse_flags.validator']

  Pulse\Flags\Core\Strategy\Validation\DateRangeStrategyValidator:
    tags: ['pulse_flags.validator']

  Pulse\Flags\Core\Strategy\Validation\CompositeStrategyValidator:
    tags: ['pulse_flags.validator']

  Pulse\Flags\Core\Strategy\Validation\CustomAttributeStrategyValidator:
    tags: ['pulse_flags.validator']

  Pulse\Flags\Core\Strategy\Validation\GeoStrategyValidator:
    tags: ['pulse_flags.validator']

  Pulse\Flags\Core\Strategy\Validation\IpStrategyValidator:
    tags: ['pulse_flags.validator']

  Pulse\Flags\Core\Strategy\Validation\ProgressiveRolloutStrategyValidator:
    tags: ['pulse_flags.validator']

  Pulse\Flags\Core\Strategy\Validation\SegmentStrategyValidator:
    tags: ['pulse_flags.validator']

  # Validation Service
  Pulse\Flags\Core\Strategy\Validation\ValidationService:
    arguments:
      $validators: !tagged_iterator pulse_flags.validator

  # Segment Repository (loaded from configuration)
  Pulse\Flags\Core\Segment\SegmentRepository:
    calls:
      - loadFromConfig: ['%pulse_flags.segments%']

  # Permanent Feature Flag Service (read-only)
  Pulse\Flags\Core\Service\PermanentFeatureFlagService:
    arguments:
      $permanentFlags: '%pulse_flags.permanent_flags%'
    calls:
      - addStrategy: ['@Pulse\Flags\Core\Strategy\SimpleStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\PercentageStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\UserIdStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\DateRangeStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\SegmentStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\CompositeStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\GeoStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\IpStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\CustomAttributeStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\ProgressiveRolloutStrategy']

  # Persistent Feature Flag Service (writable)
  Pulse\Flags\Core\Service\PersistentFeatureFlagService:
    arguments:
      $storage: '@pulse_flags.persistent_storage'
    calls:
      - addStrategy: ['@Pulse\Flags\Core\Strategy\SimpleStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\PercentageStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\UserIdStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\DateRangeStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\SegmentStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\CompositeStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\GeoStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\IpStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\CustomAttributeStrategy']
      - addStrategy: ['@Pulse\Flags\Core\Strategy\ProgressiveRolloutStrategy']

  # Main interface alias (points to persistent service for primary usage)
  Pulse\Flags\Core\Service\FeatureFlagInterface:
    alias: Pulse\Flags\Core\Service\PersistentFeatureFlagService

  Pulse\Flags\Core\Service\FeatureFlagServiceInterface:
    alias: Pulse\Flags\Core\Service\PersistentFeatureFlagService

  # Commands - Flag (CRUD operations)
  Pulse\Flags\Core\Command\Flag\CreateFlagCommand:
    tags: ['console.command']

  Pulse\Flags\Core\Command\Flag\EnableFlagCommand:
    tags: ['console.command']

  Pulse\Flags\Core\Command\Flag\DisableFlagCommand:
    tags: ['console.command']

  Pulse\Flags\Core\Command\Flag\RemoveFlagCommand:
    tags: ['console.command']

  # Commands - Query (Information)
  Pulse\Flags\Core\Command\Query\CheckFlagCommand:
    tags: ['console.command']

  Pulse\Flags\Core\Command\Query\ListFlagsCommand:
    tags: ['console.command']

  Pulse\Flags\Core\Command\Query\TestFlagCommand:
    tags: ['console.command']

  Pulse\Flags\Core\Command\Query\ValidateFlagCommand:
    tags: ['console.command']

  # Commands - Setup (Maintenance)
  Pulse\Flags\Core\Command\Setup\InitStorageCommand:
    tags: ['console.command']
    arguments:
      $persistentStorage: '@pulse_flags.persistent_storage'

  # Commands - Segment (User Segmentation)
  Pulse\Flags\Core\Command\Segment\ListSegmentsCommand:
    tags: ['console.command']

  # Twig Extension
  Pulse\Flags\Core\Twig\FeatureFlagExtension:
    tags: ['twig.extension']
